<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>√áocuklar i√ßin Kodlama</title>
  <script src="https://unpkg.com/blockly@10.0.0/blockly.min.js"></script>
  <style>
    body {
      font-family: "Comic Sans MS", cursive, sans-serif;
      background-color: #fffcec;
    }
    h2 {
      color: #ff8a65;
      text-align: center;
      font-size: 36px;
    }
    button {
      background-color: #ffcc80;
      border: none;
      color: #5d4037;
      padding: 20px 40px;
      font-size: 24px;
      margin: 20px auto;
      display: block;
      cursor: pointer;
      border-radius: 30px;
      font-family: "Comic Sans MS", cursive, sans-serif;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
    }
    button:hover {
      transform: scale(1.05);
    }
    #blocklyDiv {
      height: 500px;
      width: 90%;
      margin: 0 auto;
      border-radius: 20px;
      background-color: white;
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

  <h2>üß∏ Haydi Kodlayalƒ±m!</h2>
  <div id="blocklyDiv"></div>
  <button onclick="runCode()">üöÄ Ba≈ülat</button>

  <xml id="toolbox" style="display: none">
    <category name="üü° Ba≈üla" colour="#FFB6C1">
      <block type="start_block"></block>
    </category>
    <category name="üîµ Aksiyon" colour="#87CEFA">
      <block type="emoji_block"></block>
    </category>
    <category name="üß† Karar & D√∂ng√º" colour="#FFF176">
      <block type="repeat_block"></block>
      <block type="if_block"></block>
      <block type="yesno_block"></block>
    </category>
  </xml>

  <script>
    // Tema
    Blockly.Theme.defineTheme('babyTheme', {
      base: Blockly.Themes.Classic,
      fontStyle: {
        family: '"Comic Sans MS", cursive, sans-serif',
        weight: 'bold',
        size: 14
      },
      componentStyles: {
        workspaceBackgroundColour: '#fffcef',
        toolboxBackgroundColour: '#fff3e0',
        toolboxForegroundColour: '#ff8a65',
        flyoutBackgroundColour: '#fff8e1',
        flyoutOpacity: 0.9,
        scrollbarColour: '#ffe0b2',
        cursorColour: '#ffa726'
      }
    });

    // Ba≈üla bloƒüu
    Blockly.Blocks['start_block'] = {
      init: function () {
        this.appendDummyInput().appendField("üü¢ Ba≈üla");
        this.setNextStatement(true, null);
        this.setColour("#FFB6C1");
        this.setTooltip("Program ba≈ülasƒ±n");
      }
    };
    Blockly.JavaScript['start_block'] = function () {
      return '// Ba≈üladƒ±\n';
    };

    // Hayvan sesi bloƒüu
    Blockly.Blocks['emoji_block'] = {
      init: function () {
        this.appendDummyInput().appendField("üê± Hayvan sesi √ßƒ±kar");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour("#87CEFA");
        this.setTooltip("Sevimli hayvan sesi");
      }
    };


    Blockly.JavaScript['emoji_block'] = function () {
      var code = `
#!/usr/bin/env python3
from pidog import Pidog
from time import sleep
from preset_actions import howling

my_dog = Pidog()

sleep(0.5)

def main():
    my_dog.do_action('sit', speed=50)
    my_dog.head_move([[0, 0, 0]], pitch_comp=-40, immediately=True, speed=80)
    sleep(0.5)
    while True:
        howling(my_dog)

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        pass
    except Exception as e:
        print(f"\\033[31mERROR: {e}\\033[m")
    finally:
        my_dog.close()
`;
  return code;
    };

   
    


    // Tekrar Et bloƒüu
    Blockly.Blocks['repeat_block'] = {
      init: function () {
        this.appendDummyInput()
          .appendField("üîÅ Tekrar et")
          .appendField(new Blockly.FieldNumber(3, 1, 10), "COUNT")
          .appendField("kez");
        this.appendStatementInput("DO").setCheck(null).appendField("üëâ Yap:");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour("#FFD54F");
        this.setTooltip("Bir ≈üeyi tekrar tekrar yapar");
      }
    };
    Blockly.JavaScript['repeat_block'] = function (block) {
      const count = block.getFieldValue('COUNT');
      const statements = Blockly.JavaScript.statementToCode(block, 'DO');
      return `for (let i = 0; i < ${count}; i++) {\n${statements}}\n`;
    };

    // Eƒüer bloƒüu
    Blockly.Blocks['if_block'] = {
      init: function () {
        this.appendValueInput("CONDITION").setCheck("Boolean")
            .appendField("‚ùì Eƒüer bu doƒüruysa:");
        this.appendStatementInput("DO").setCheck(null).appendField("‚úÖ Yap:");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour("#FF8A65");
        this.setTooltip("Eƒüer durum doƒüruysa bir ≈üey yapar");
      }
    };
    Blockly.JavaScript['if_block'] = function (block) {
      const condition = Blockly.JavaScript.valueToCode(block, 'CONDITION', Blockly.JavaScript.ORDER_NONE) || 'false';
      const doCode = Blockly.JavaScript.statementToCode(block, 'DO');
      return `if (${condition}) {\n${doCode}}\n`;
    };

    // Evet/Hayƒ±r bloƒüu
    Blockly.Blocks['yesno_block'] = {
      init: function () {
        this.appendDummyInput()
            .appendField("üôÇ Doƒüru mu?")
            .appendField(new Blockly.FieldDropdown([["Evet", "true"], ["Hayƒ±r", "false"]]), "BOOL");
        this.setOutput(true, "Boolean");
        this.setColour("#AED581");
        this.setTooltip("Evet veya Hayƒ±r");
      }
    };
    Blockly.JavaScript['yesno_block'] = function (block) {
      const val = block.getFieldValue('BOOL');
      return [val, Blockly.JavaScript.ORDER_ATOMIC];
    };

    // Blockly ba≈ülat
    const workspace = Blockly.inject('blocklyDiv', {
      toolbox: document.getElementById('toolbox'),
      theme: 'babyTheme',
      renderer: 'zelos',
      trashcan: false,
      zoom: {
        startScale: 1.3,
        controls: true,
        wheel: false
      },
      grid: {
        spacing: 25,
        length: 3,
        colour: '#ccc',
        snap: true
      }
    });

    // √áalƒ±≈ütƒ±r butonu
    function runCode() {
      try {
        // Blockly √ßalƒ±≈üma alanƒ±ndaki kodu al
        const code = Blockly.JavaScript.workspaceToCode(workspace);
    
        // JSON veri formatƒ±
        const jsonData = {
          code: code,
          timestamp: new Date().toISOString(),
          user: "test_kullanici"
        };
    
        console.log("G√∂nderilen JSON:", JSON.stringify(jsonData, null, 2));
    
        // Sunucuya POST isteƒüi
        fetch('http://192.168.1.140:5280/execute', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(jsonData)
        })
        .then(response => {
          if (!response.ok) throw new Error("Sunucu hatasƒ±");
          return response.json();
        })
        .then(data => {
          console.log("Sunucu yanƒ±tƒ±:", data);
          eval(code); // yalnƒ±zca ba≈üarƒ±lƒ± g√∂nderim sonrasƒ± kodu √ßalƒ±≈ütƒ±r
        })
        .catch(error => {
          console.error("POST hatasƒ±:", error);
          alert("G√∂nderme hatasƒ±: " + error.message);
        });
    
      } catch (e) {
        alert("Kod √ßalƒ±≈ütƒ±rma hatasƒ±: " + e);
      }
    }
    
    
    
  </script>
</body>
</html>
